= Сеть 2
Влад хочет зайти вк 

Имеем только ip adders, gateway, mask

1. При открытии кладки браузер резервирует случайный порт 32123
2. вк имеет адрес  http://vk.com (7.7.7.7)

на телефоне скорее всего 3 сетевых интерфейса: loopback, wifi, мобильный интернет

каждая передача данных отправляется тройкой GW, adres, port 

Каждый пакет http данных оборачивается в префикс 

* port отправителя (32123), port получателя (хранится в волшебном файлике ОС)
* ip отправителя (наш ..1.3), ip получателя (получаем от dns сервера)
* mac адрес отправителя (мобильного), mac адрес получателя (точка доступа, смотрим в таблицу маршрутизации, а туда он попал через широковещательный arc запрос)

image::media/2023-12-19-15-46-19.png[]

Что делает маршрутизатор? 

* физический: mac мой? да -- читаем дальше 
* сетевой: ip мой? нет. другое устройство отбросило бы, но шлюз лезет в таблицу маршрутизации, ищет сеть к какой относится ip и *отправляет* ее туда. Меняет mac
* транспортный:  возможно перед этим делает NAT (у Влада серый адрес, ставим ip шлюза и како-то порт). Куда отправляем? Следующему маршрутизатору и т.д.

У граничных серверов автономной зоны маска 0.0.0.0

Что делает сервер вк?

* mac наш
* ip наш 
* транспортный (порт) есть ли на устройстве программа, которая слушает данный порт? да 
* приложение -- обрабатывает данные.

== Switch: какие бывают 

=== L4 
В режиме реального времени (не снижая скорость. нужен ооочень мощный процессор. алгоритмы анализа сложнее) умеет разворачивать до уровня приложений. Например, блокировать пакеты с запрещенных сайтов. (~ от 500к деняк)

=== L3 
Умеет делать NAT (~ от 30-40к деняк). нужны провайдерам

=== L2+ 
В режиме реального времени делает до второго уровня (IP), а до всех уровней выше -- с потенциальной задержкой, программно. То есть делает NAT долго.(~ 8к деняк)

=== L2 

=== L1 (hub)
Формально умеет ничего. Знает только про `mac` адреса. Для объединения всех компов в одну локальную сеть. Сеть может не иметь ни `ip`, ни `mac`. 

плох тем, что можно слушать чужой трафик.

сейчас они умнее, запоминают какому порту какой мак адрес соответствует и пришедший пакет отправляем ему. если мы его не запомнили, то отправляем всем.

== Откуда у Влада адрес? DHCP
Его дает DHCP, который работает на уровне приложения

последний адрес в сети -- широковещательный. отправляется всем.чтобы так сделать -- у мак адресов тоже есть широковещательный адрес `FF:FF:..:FF`.

компьютер обязан обработать широковещательный запрос не только в рамках сети, но и общей сети. поэтому пока влад даже маски не знает он шлет пакет по маске `255.255.255.255`. Сеть уже не обрабатывает! 

`DHCP` имеет свой порт. Если в сети есть ПК с `dhcp` сервером, то она послушает, выдаст адрес и отправит обратно. "обратно" кому? мы знаем мак, но не знаем `ip` (ставим 0.0.0.0, в некоторых протоколах есть специальный "дефолтный" адрес, который устройство считает за свой пока не получит настоящий. зависит от версии протокола)

Что еще умеет выдавать dhcp?

*  насколько мы выдали адрес.
* `PXE` -- по сети можно получить файлик, с которого стартануть ОС. легко обновлять всякие терминалы: обновляем только файлик на сервере. dhcp выдает ссылку на этот файлик.
* `DNS` сервер

== DNS: каким образом vk.com превращается в 7.7.7.7
DNS сервер по доменному имени возвращает ip адрес. 

Кто у влада скорее всего dns сервер? скорее всего точка доступа. чтобы можно было задавать имена локально в сети. Он выдает что знает или ретранслирует запрос своему серверу на шаг выше. В данном случае провайдеру. 

Есть сервер, который отвечает за какой-то домен. Например, за vk.com. Там может быть v1.edu.vk.com  

Корневой `dns` сервер -- царь и бог, который знает все (их от 12 до 15). На самом деле безумно глупое устройство, т.к. отвечает только за домены первого уровня (`com`, `org`, `ru`).

Как выдается запрос? 

* Рекурсивно. Явно проходим через все сервера и обратно

`+` на какое-то время все сервера на пути закешируют нужный `ip`.

`-` все по дороге страдают

* Как делают на самом деле: до какого-то уровня рекурсивный (обычно провайдер провайдера), который уже сам обращается ко всем остальным. Если он не знает "остальных" -- спрашивает у верхнего `dns`.

Нельзя кешировать адреса дольше, чем на сутки.

=== Что хранится в DNS сервере?

Табличка вида 

имя          тип записи          ip

v1 (имя пк)             A               7.7.7.7

<A -- access?>

vx  (имя пк)          CNAME             v1 

super (поддомен)        NS            7.1.2.3 

<если что-то обратиться к зоне super  (super.vk.com) -- то у него такой сервер>

.                       A               7.2.3.4 

www                     CNAME               . 

.                       MX              mail.ru.

<MX -- тип записи для почтового сервера>

<точка в конце принципиальна, иначе шли бы на `mail.ru.edu.vk.com`, а так сразу на `mail.ru`>




Следующий раз: 

1. TCP\UDP 
2. ICMP (если мыши перегрызли провод)
3. Динамическая маршрутизация
4. Программирование 